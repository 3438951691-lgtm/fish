<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Christmas Tree</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #0b1a2a 0%, #000000 100%);
            font-family: 'Times New Roman', serif;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        /* åŠ è½½åŠ¨ç”» */
        #loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-out;
        }

        .loader-text {
            color: #aaddff;
            font-size: 14px;
            letter-spacing: 4px;
            margin-top: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid #00ffcc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æ ‡é¢˜ */
        h1 {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            text-align: center;
            margin: 0;
            pointer-events: none;
            font-size: 36px;
            font-weight: 400;
            background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 50%, #88ccff 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: aurora-shine 6s linear infinite;
            opacity: 0.9;
        }

        @keyframes aurora-shine {
            0% { background-position: 0% center; }
            100% { background-position: 300% center; }
        }

        /* ä¸Šä¼ æŒ‰é’® */
        .upload-wrapper {
            position: absolute;
            top: 40px;
            right: 40px;
            z-index: 20;
            pointer-events: auto;
            display: flex;
            gap: 10px;
        }

        .upload-btn, .control-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            padding: 8px 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 10px;
            text-transform: uppercase;
            backdrop-filter: blur(5px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn:hover, .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #00ffcc;
            color: #fff;
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.2);
        }

        .control-btn.active {
            background: rgba(0, 255, 204, 0.1);
            border-color: #00ffcc;
            color: #00ffcc;
        }

        #file-input, #import-input {
            display: none;
        }

        /* æ‘„åƒå¤´é¢„è§ˆçª—å£ */
        #webcam-wrapper {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 160px;
            height: 120px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            opacity: 0.8;
            z-index: 20;
            background: #000;
        }

        #webcam-wrapper canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        /* æ“ä½œæç¤º */
        #tips {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 15px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 10px;
            backdrop-filter: blur(10px);
            z-index: 15;
        }

        .tip-item {
            margin: 6px 0;
        }

        .tip-key {
            color: #00ffcc;
            display: inline-block;
            min-width: 60px;
        }

        /* ç¼“å­˜ç®¡ç†æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: rgba(10, 20, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            gap: 15px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
            margin-right: 15px;
        }

        .modal-header h2 {
            margin: 0;
            color: #fff;
            font-size: 18px;
            font-weight: 400;
        }

        .modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .photo-item {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .photo-item:hover {
            border-color: #00ffcc;
            transform: translateY(-2px);
        }

        .photo-item.in-scene {
            border-color: #00ffcc;
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.3);
        }

        .photo-thumb {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            display: block;
        }

        .photo-info {
            padding: 8px;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        .photo-size {
            margin-bottom: 4px;
        }

        .photo-status {
            color: #00ffcc;
            font-size: 9px;
        }

        .photo-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .photo-action-btn {
            flex: 1;
            padding: 6px 4px;
            font-size: 9px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .photo-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .photo-action-btn.add-scene {
            border-color: #00ffcc;
            color: #00ffcc;
        }

        .photo-action-btn.add-scene:hover {
            background: rgba(0, 255, 204, 0.1);
        }

        .photo-action-btn.remove-scene {
            border-color: #ffaa00;
            color: #ffaa00;
        }

        .photo-action-btn.delete {
            border-color: #ff4444;
            color: #ff4444;
        }

        .photo-action-btn.delete:hover {
            background: rgba(255, 68, 68, 0.1);
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
        }

        .modal-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 14px;
            font-size: 11px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
            color: #fff;
        }

        .modal-action-btn.upload {
            border-color: #00ffcc;
            color: #00ffcc;
        }

        .modal-action-btn.upload:hover {
            background: rgba(0, 255, 204, 0.1);
        }

        .modal-action-btn.import {
            border-color: #88aaff;
            color: #88aaff;
        }

        .modal-action-btn.import:hover {
            background: rgba(136, 170, 255, 0.1);
        }

        .modal-action-btn.export {
            border-color: #ffaa00;
            color: #ffaa00;
        }

        .modal-action-btn.export:hover {
            background: rgba(255, 170, 0, 0.1);
        }

        .cache-stats {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }

        .cache-stats .highlight {
            color: #00ffcc;
        }

        .cache-stats .warning {
            color: #ffaa00;
        }

        .clear-all-btn {
            padding: 8px 16px;
            font-size: 11px;
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ff4444;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clear-all-btn:hover {
            background: rgba(255, 68, 68, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.4);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* æ‘„åƒå¤´æƒé™è¯¢é—®å¼¹çª—æ ·å¼ */
        #camera-permission-modal {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
            display: none;
        }

        #camera-permission-modal.show {
            display: block;
        }

        #camera-permission-modal .modal-content {
            max-width: 260px;
            background: rgba(10, 20, 30, 0.95);
            border: 1px solid rgba(0, 255, 204, 0.3);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        #camera-permission-modal .modal-header {
            border-bottom: none;
            padding: 0 0 10px 0;
        }

        #camera-permission-modal .modal-header h2 {
            font-size: 14px;
            color: #00ffcc;
            margin: 0;
        }

        #camera-permission-modal .modal-body {
            padding: 0;
        }

        #camera-permission-modal .modal-body p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin: 5px 0;
        }

        #camera-permission-modal .modal-footer {
            display: flex;
            gap: 10px;
            padding: 12px 0 0 0;
            border-top: none;
        }

        #camera-permission-modal .modal-action-btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
        }

        /* å¯¼å‡ºå‘½åå¯¹è¯æ¡†æ ·å¼ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00ffcc;
        }

        .form-group input[readonly] {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .filename-preview {
            padding: 10px;
            background: rgba(0, 255, 204, 0.1);
            border-radius: 6px;
            color: #00ffcc;
            font-size: 12px;
            word-break: break-all;
        }

        /* éŸ³ä¹ç®¡ç†æ ·å¼ */
        .music-source-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .music-tab {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .music-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .music-tab.active {
            background: rgba(0, 255, 204, 0.1);
            border-color: #00ffcc;
            color: #00ffcc;
        }

        .music-tab-content {
            padding: 15px 0;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #00ffcc;
            background: rgba(0, 255, 204, 0.05);
        }

        .upload-area.dragover {
            border-color: #00ffcc;
            background: rgba(0, 255, 204, 0.1);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .upload-hint {
            color: rgba(255, 255, 255, 0.4);
            font-size: 11px;
        }

        .current-music-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .music-info-label {
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
            margin-bottom: 5px;
        }

        .music-info-value {
            color: #00ffcc;
            font-size: 13px;
            word-break: break-all;
        }

        .music-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .music-control-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .music-control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #00ffcc;
            color: #00ffcc;
        }

        .music-control-btn.playing {
            background: rgba(0, 255, 204, 0.1);
            border-color: #00ffcc;
            color: #00ffcc;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: flex-end;
        }

        .volume-label {
            font-size: 16px;
        }

        .volume-value {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            min-width: 35px;
        }

        #music-volume {
            width: 100px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
        }

        #music-volume::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: #00ffcc;
            border-radius: 50%;
            cursor: pointer;
        }

        #music-volume::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: #00ffcc;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
            }
        }
    </script>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text">Loading...</div>
    </div>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <h1>Merry Christmas</h1>
        <div class="upload-wrapper">
            <button class="control-btn" id="manage-btn" title="ç®¡ç†ç¼“å­˜ç…§ç‰‡">ğŸ“ ç®¡ç†</button>
            <button class="control-btn" id="music-btn" title="æ’­æ”¾/æš‚åœéŸ³ä¹">ğŸµ éŸ³ä¹</button>
        </div>
    </div>

    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bg-music" loop preload="auto">
    <source src="lbiåˆ©æ¯”(æ—¶æŸå°˜)-æ·‹ä¸€åœºé›¨.mp3" type="audio/mpeg">

</audio>
    

    <div id="webcam-wrapper">
        <video id="webcam" autoplay playsinline style="display:none;"></video>
        <canvas id="webcam-preview"></canvas>
    </div>

    <!-- ç¼“å­˜ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="cache-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç…§ç‰‡ç¼“å­˜ç®¡ç†</h2>
                <div class="header-actions">
                    <label class="modal-action-btn upload">
                        ğŸ“· ä¸Šä¼ ç…§ç‰‡
                        <input type="file" id="file-input" multiple accept="image/*" style="display:none;">
                    </label>
                    <label class="modal-action-btn import">
                        ğŸ“¥ å¯¼å…¥
                        <input type="file" id="import-input" accept=".json" style="display:none;">
                    </label>
                    <button class="modal-action-btn export" id="export-btn">ğŸ“¤ å¯¼å‡º</button>
                </div>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="photo-grid" class="photo-grid"></div>
            </div>
            <div class="modal-footer">
                <div class="cache-stats" id="cache-stats">
                    å·²ç¼“å­˜ <span class="highlight">0</span> å¼ ç…§ç‰‡ (<span class="highlight">0 KB</span> / 50 MB)
                </div>
                <button class="clear-all-btn" id="clear-all-btn">æ¸…ç©ºå…¨éƒ¨</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºå‘½åå¯¹è¯æ¡† -->
    <div id="export-name-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>å¯¼å‡ºç…§ç‰‡</h2>
                <button class="modal-close" id="export-name-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ä¸»é¢˜å</label>
                    <input type="text" id="export-theme" value="Merry Christmas">
                </div>
                <div class="form-group">
                    <label>è‡ªå®šä¹‰åç§°</label>
                    <input type="text" id="export-custom" placeholder="ä¾‹ï¼šå¥³æœ‹å‹é“ç…§åˆé›†">
                </div>
                <div class="form-group">
                    <label>æ—¥æœŸ</label>
                    <input type="text" id="export-date" readonly>
                </div>
                <div class="filename-preview">
                    é¢„è§ˆ: <span id="filename-preview"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-action-btn" id="export-cancel">å–æ¶ˆ</button>
                <button class="modal-action-btn export" id="export-confirm">ç¡®è®¤å¯¼å‡º</button>
            </div>
        </div>
    </div>

    <!-- éŸ³ä¹ç®¡ç†å¯¹è¯æ¡† -->
    <div id="music-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ğŸµ éŸ³ä¹ç®¡ç†</h2>
                <button class="modal-close" id="music-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="music-source-tabs">
                    <button class="music-tab active" data-tab="url">ğŸ”— éŸ³ä¹é“¾æ¥</button>
                    <button class="music-tab" data-tab="upload">ğŸ“ ä¸Šä¼ æ–‡ä»¶</button>
                </div>

                <div class="music-tab-content" id="tab-url">
                    <div class="form-group">
                        <label>è¾“å…¥éŸ³ä¹é“¾æ¥ (æ”¯æŒ MP3, WAV, OGG ç­‰æ ¼å¼)</label>
                        <input type="text" id="music-url-input" placeholder="https://example.com/music.mp3">
                    </div>
                    <button class="modal-action-btn upload" id="apply-url-btn" style="width: 100%;">åº”ç”¨é“¾æ¥</button>
                </div>

                <div class="music-tab-content" id="tab-upload" style="display: none;">
                    <div class="form-group">
                        <label>é€‰æ‹©æœ¬åœ°éŸ³é¢‘æ–‡ä»¶</label>
                        <div class="upload-area" id="music-upload-area">
                            <div class="upload-icon">ğŸµ</div>
                            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½éŸ³é¢‘æ–‡ä»¶åˆ°è¿™é‡Œ</div>
                            <div class="upload-hint">æ”¯æŒ MP3, WAV, OGG, M4A æ ¼å¼</div>
                            <input type="file" id="music-file-input" accept="audio/*" style="display: none;">
                        </div>
                    </div>
                </div>

                <div class="current-music-info" id="current-music-info">
                    <div class="music-info-label">å½“å‰éŸ³ä¹:</div>
                    <div class="music-info-value" id="current-music-name">é»˜è®¤éŸ³ä¹</div>
                </div>

                <div class="music-controls">
                    <button class="music-control-btn" id="music-play-btn">â–¶ æ’­æ”¾</button>
                    <button class="music-control-btn" id="music-pause-btn">â¸ æš‚åœ</button>
                    <div class="volume-control">
                        <span class="volume-label">ğŸ”Š</span>
                        <input type="range" id="music-volume" min="0" max="100" value="50">
                        <span class="volume-value" id="volume-value">50%</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-action-btn" id="music-reset-btn">ğŸ”„ æ¢å¤é»˜è®¤</button>
                <button class="modal-action-btn export" id="music-close-btn">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- æ‘„åƒå¤´æƒé™è¯¢é—®å¼¹çª— -->
    <div id="camera-permission-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>å¼€å¯æ‘„åƒå¤´ï¼Ÿ</h2>
            </div>
            <div class="modal-body">
                <p>å¼€å¯åå¯ç”¨æ‰‹åŠ¿æ§åˆ¶åœºæ™¯</p>
                <p>ä¸å¼€å¯åˆ™ç”¨é”®ç›˜æ§åˆ¶</p>
            </div>
            <div class="modal-footer">
                <button class="modal-action-btn" id="camera-deny-btn">è·³è¿‡</button>
                <button class="modal-action-btn upload" id="camera-allow-btn">å¼€å¯</button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        // å…¨å±€å˜é‡
        let scene, camera, renderer, composer, bloomPass, mainGroup;
        let clock = new THREE.Clock();
        let particleSystem = [], photoMeshGroup = new THREE.Group();
        let handLandmarker, video, webcamCanvas, webcamCtx;
        let snowSystem;
        let photoDataArray = []; // å­˜å‚¨æ‰€æœ‰ç…§ç‰‡çš„base64æ•°æ®
        let photoIdToMeshMap = new Map(); // ç…§ç‰‡IDåˆ°åœºæ™¯meshçš„æ˜ å°„

        // ========== é¢„ç½®ç…§ç‰‡æ•°æ® ==========
        // ä½¿ç”¨æ–¹æ³•ï¼šå°†å¯¼å‡ºçš„JSONæ–‡ä»¶ä¸­çš„ photos æ•°ç»„å†…å®¹ç²˜è´´åˆ°ä¸‹é¢çš„æ•°ç»„ä¸­
        // æ ¼å¼ç¤ºä¾‹ï¼š["data:image/jpeg;base64,/9j/4AAQ...", "data:image/png;base64,iVBORw0..."]
        const PRESET_PHOTOS = [];
        // ====================================

        // ç¼“å­˜é…ç½®
        const CACHE_CONFIG = {
            maxPhotos: 20,
            maxSizeMB: 50,
            dbName: 'ChristmasTreeDB',
            storeName: 'photos',
            // éŸ³ä¹ç¼“å­˜é…ç½®
            musicStoreName: 'music',
            maxMusicSizeMB: 20
        };

        // IndexedDB å·¥å…·å‡½æ•°
        const PhotoCache = {
            db: null,

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(CACHE_CONFIG.dbName, 1);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(CACHE_CONFIG.storeName)) {
                            const store = db.createObjectStore(CACHE_CONFIG.storeName, { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                    };
                });
            },

            async savePhoto(base64Data) {
                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºé™åˆ¶
                const stats = await this.getStats();
                const newSize = this.getBase64Size(base64Data);

                if (stats.count >= CACHE_CONFIG.maxPhotos) {
                    return { success: false, reason: 'count', message: `å·²è¾¾åˆ°æœ€å¤§ç¼“å­˜æ•°é‡ (${CACHE_CONFIG.maxPhotos} å¼ )ï¼Œè¯·å…ˆåˆ é™¤ä¸€äº›ç…§ç‰‡` };
                }

                if ((stats.totalSize + newSize) / (1024 * 1024) > CACHE_CONFIG.maxSizeMB) {
                    return { success: false, reason: 'size', message: `å·²è¾¾åˆ°æœ€å¤§ç¼“å­˜å¤§å° (${CACHE_CONFIG.maxSizeMB} MB)ï¼Œè¯·å…ˆåˆ é™¤ä¸€äº›ç…§ç‰‡` };
                }

                const photo = {
                    id: 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    base64: base64Data,
                    timestamp: Date.now(),
                    size: newSize,
                    inScene: true
                };

                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readwrite');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.add(photo);
                    request.onsuccess = () => resolve({ success: true, photo });
                    request.onerror = () => resolve({ success: false, reason: 'db', message: 'ä¿å­˜å¤±è´¥' });
                });
            },

            async getAllPhotos() {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readonly');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => resolve([]);
                });
            },

            async deletePhoto(id) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readwrite');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => resolve(false);
                });
            },

            async updatePhoto(photo) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readwrite');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.put(photo);
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => resolve(false);
                });
            },

            async clearAll() {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readwrite');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => resolve(false);
                });
            },

            async getStats() {
                const photos = await this.getAllPhotos();
                const totalSize = photos.reduce((sum, p) => sum + (p.size || 0), 0);
                return {
                    count: photos.length,
                    totalSize,
                    inSceneCount: photos.filter(p => p.inScene).length
                };
            },

            getBase64Size(base64) {
                // è®¡ç®—base64å­—ç¬¦ä¸²çš„å®é™…å­—èŠ‚å¤§å°
                const base64Length = base64.length - (base64.indexOf(',') + 1);
                const padding = (base64.match(/=+$/) || [''])[0].length;
                return Math.floor((base64Length * 3) / 4) - padding;
            },

            formatSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            }
        };

        // æè´¨å¯¹è±¡
        const MATERIALS = {};

        // çŠ¶æ€ç®¡ç†
        const STATE = {
            mode: 'TREE', // TREE, SCATTER, FOCUS
            hand: { detected: false, x: 0, y: 0 },
            rotation: { x: 0, y: 0 },
            camera: {
                targetPos: new THREE.Vector3(0, 2, 50),
                targetLookAt: new THREE.Vector3(0, 0, 0),
                currentLookAt: new THREE.Vector3(0, 0, 0)
            },
            focusTarget: null
        };

        // åˆå§‹åŒ– Three.js
        function initThree() {
            const container = document.getElementById('canvas-container');

            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x111111, 0.02);

            camera = new THREE.PerspectiveCamera(42, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 50);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ReinhardToneMapping;
            renderer.toneMappingExposure = 2.2;
            container.appendChild(renderer.domElement);

            scene.environment = new THREE.PMREMGenerator(renderer).fromScene(new RoomEnvironment(), 0.04).texture;

            mainGroup = new THREE.Group();
            scene.add(mainGroup);
        }

        // åˆ›å»ºæè´¨
        function createMaterials() {
            MATERIALS.gold = new THREE.MeshStandardMaterial({
                color: 0x88ccff,
                metalness: 1.0,
                roughness: 0.1,
                envMapIntensity: 2.0,
                emissive: 0x002244,
                emissiveIntensity: 0.3
            });

            MATERIALS.green = new THREE.MeshStandardMaterial({
                color: 0x051020,
                metalness: 0.2,
                roughness: 0.8,
                emissive: 0x000510,
                emissiveIntensity: 0.2
            });

            MATERIALS.red = new THREE.MeshPhysicalMaterial({
                color: 0xffffff,
                metalness: 0.3,
                roughness: 0.2,
                clearcoat: 1.0,
                emissive: 0x222222
            });

            MATERIALS.frame = new THREE.MeshBasicMaterial({ color: 0xffffff });

            MATERIALS.star = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                emissive: 0x88ccff,
                emissiveIntensity: 1.0,
                metalness: 1.0,
                roughness: 0
            });

            // ç³–æœçº¹ç†
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, 128, 128);
            ctx.fillStyle = '#0088ff';
            ctx.beginPath();
            for (let i = -128; i < 256; i += 32) {
                ctx.moveTo(i, 0);
                ctx.lineTo(i + 32, 128);
                ctx.lineTo(i + 16, 128);
                ctx.lineTo(i - 16, 0);
            }
            ctx.fill();
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(3, 3);
            MATERIALS.candy = new THREE.MeshStandardMaterial({ map: texture, roughness: 0.4 });
        }

        // è®¾ç½®ç¯å…‰
        function setupLights() {
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));

            const innerLight = new THREE.PointLight(0x0066ff, 2, 20);
            innerLight.position.set(0, 5, 0);
            mainGroup.add(innerLight);

            const spot1 = new THREE.SpotLight(0xeefbff, 1500);
            spot1.position.set(30, 40, 40);
            scene.add(spot1);

            const spot2 = new THREE.SpotLight(0x8844ff, 800);
            spot2.position.set(-30, 20, -30);
            scene.add(spot2);

            const fill = new THREE.DirectionalLight(0xaaccff, 0.8);
            fill.position.set(0, 0, 50);
            scene.add(fill);
        }

        // ç²’å­ç±»
        class Particle {
            constructor(mesh, type) {
                this.mesh = mesh;
                this.type = type;
                this.posTree = new THREE.Vector3();
                this.posScatter = new THREE.Vector3();
                this.baseScale = mesh.scale.x;
                this.spinSpeed = new THREE.Vector3(
                    Math.random() - 0.5,
                    Math.random() - 0.5,
                    Math.random() - 0.5
                ).multiplyScalar(type === 'PHOTO' ? 0.3 : 2.0);

                // æ ‘å½¢ä½ç½®
                const h = 24, halfH = 12;
                let t = Math.pow(Math.random(), 0.8);
                const y = (t * h) - halfH;
                const r = Math.max(0.5, 8 * (1.0 - t)) * (0.8 + Math.random() * 0.4);
                const a = t * 50 * Math.PI + Math.random() * Math.PI;
                this.posTree.set(Math.cos(a) * r, y, Math.sin(a) * r);

                // æ•£å¼€ä½ç½®
                const rs = 12 + Math.random() * 25;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                this.posScatter.set(
                    rs * Math.sin(phi) * Math.cos(theta),
                    rs * Math.sin(phi) * Math.sin(theta),
                    rs * Math.cos(phi)
                );
            }

            update(dt, mode) {
                let target = (mode === 'SCATTER' || mode === 'FOCUS') ? this.posScatter : this.posTree;
                this.mesh.position.lerp(target, 2.5 * dt);

                // æœå‘æ§åˆ¶
                if (mode === 'FOCUS' && STATE.focusTarget === this.mesh) {
                    this.mesh.lookAt(camera.position);
                } else if (mode === 'SCATTER') {
                    this.mesh.rotation.x += this.spinSpeed.x * dt;
                    this.mesh.rotation.y += this.spinSpeed.y * dt;
                } else {
                    this.mesh.rotation.set(
                        THREE.MathUtils.lerp(this.mesh.rotation.x, 0, dt),
                        this.mesh.rotation.y + 0.5 * dt,
                        THREE.MathUtils.lerp(this.mesh.rotation.z, 0, dt)
                    );
                }

                // ç¼©æ”¾æ§åˆ¶
                let s = this.baseScale;
                if ((mode === 'SCATTER' || mode === 'FOCUS') && this.type === 'PHOTO') {
                    s = this.baseScale * 2.5;
                }
                this.mesh.scale.lerp(new THREE.Vector3(s, s, s), 4 * dt);
            }
        }

        // åˆ›å»ºç²’å­ç³»ç»Ÿ
        function createParticles() {
            const sphere = new THREE.SphereGeometry(0.5, 32, 32);
            const box = new THREE.BoxGeometry(0.55, 0.55, 0.55);
            const curve = new THREE.CatmullRomCurve3([
                new THREE.Vector3(0, -0.5, 0),
                new THREE.Vector3(0, 0.3, 0),
                new THREE.Vector3(0.1, 0.5, 0),
                new THREE.Vector3(0.3, 0.4, 0)
            ]);
            const candy = new THREE.TubeGeometry(curve, 16, 0.08, 8, false);

            for (let i = 0; i < 1500; i++) {
                const r = Math.random();
                let mesh, type;

                if (r < 0.4) {
                    mesh = new THREE.Mesh(box, MATERIALS.green);
                    type = 'BOX';
                } else if (r < 0.7) {
                    mesh = new THREE.Mesh(box, MATERIALS.gold);
                    type = 'GOLD_BOX';
                } else if (r < 0.92) {
                    mesh = new THREE.Mesh(sphere, MATERIALS.gold);
                    type = 'GOLD_SPHERE';
                } else if (r < 0.97) {
                    mesh = new THREE.Mesh(sphere, MATERIALS.red);
                    type = 'RED';
                } else {
                    mesh = new THREE.Mesh(candy, MATERIALS.candy);
                    type = 'CANE';
                }

                const s = 0.4 + Math.random() * 0.5;
                mesh.scale.set(s, s, s);
                mesh.rotation.set(Math.random() * 6, Math.random() * 6, Math.random() * 6);

                mainGroup.add(mesh);
                particleSystem.push(new Particle(mesh, type));
            }

            // é¡¶éƒ¨æ˜Ÿæ˜Ÿ
            const star = new THREE.Mesh(new THREE.OctahedronGeometry(1.2, 0), MATERIALS.star);
            star.position.set(0, 13.2, 0);
            mainGroup.add(star);

            mainGroup.add(photoMeshGroup);
        }

        // åˆ›å»ºé›ªèŠ±
        function createSnow() {
            const positions = new Float32Array(3000);
            for (let i = 0; i < 3000; i += 3) {
                positions[i] = (Math.random() - 0.5) * 80;
                positions[i + 1] = (Math.random() - 0.5) * 80 + 20;
                positions[i + 2] = (Math.random() - 0.5) * 80;
            }

            snowSystem = new THREE.Points(
                new THREE.BufferGeometry().setAttribute('position', new THREE.BufferAttribute(positions, 3)),
                new THREE.PointsMaterial({
                    color: 0xffffff,
                    size: 0.2,
                    transparent: true,
                    opacity: 0.6,
                    blending: THREE.AdditiveBlending
                })
            );
            scene.add(snowSystem);
        }

        // åˆ›å»ºé»˜è®¤ç…§ç‰‡
        let defaultPhotoTexture;
        function createDefaultPhotos() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = '#050505';
            ctx.fillRect(0, 0, 512, 512);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 15;
            ctx.strokeRect(20, 20, 472, 472);
            ctx.font = '500 60px Times New Roman';
            ctx.fillStyle = '#aaddff';
            ctx.textAlign = 'center';
            ctx.fillText("é¢„ç¥å®¶äººä»¬", 256, 230);
            ctx.fillText("åœ£è¯å¿«ä¹ï¼", 256, 300);

            defaultPhotoTexture = new THREE.CanvasTexture(canvas);
            defaultPhotoTexture.colorSpace = THREE.SRGBColorSpace;
            addPhotoToScene(defaultPhotoTexture);
        }

        // æ·»åŠ ç…§ç‰‡åˆ°åœºæ™¯
        function addPhotoToScene(texture, base64Data = null, photoId = null) {
            const ar = texture.image.width / texture.image.height;
            const w = ar > 1 ? 1.2 : 1.2 * ar;
            const h = ar > 1 ? 1.2 / ar : 1.2;

            const group = new THREE.Group();
            group.add(new THREE.Mesh(
                new THREE.BoxGeometry(w + 0.1, h + 0.1, 0.05),
                MATERIALS.frame
            ));

            const photo = new THREE.Mesh(
                new THREE.PlaneGeometry(w, h),
                new THREE.MeshBasicMaterial({ map: texture })
            );
            photo.position.z = 0.04;
            group.add(photo);
            group.scale.setScalar(0.8);

            // å­˜å‚¨photoIdä»¥ä¾¿åç»­ç®¡ç†
            if (photoId) {
                group.userData.photoId = photoId;
                photoIdToMeshMap.set(photoId, group);
            }

            photoMeshGroup.add(group);
            particleSystem.push(new Particle(group, 'PHOTO'));

            // ä¿å­˜base64æ•°æ®
            if (base64Data) {
                photoDataArray.push(base64Data);
            }

            return group;
        }

        // ä»åœºæ™¯ç§»é™¤ç…§ç‰‡
        function removePhotoFromScene(photoId) {
            const mesh = photoIdToMeshMap.get(photoId);
            if (mesh) {
                // ä»ç²’å­ç³»ç»Ÿä¸­ç§»é™¤
                const particleIndex = particleSystem.findIndex(p => p.mesh === mesh);
                if (particleIndex !== -1) {
                    particleSystem.splice(particleIndex, 1);
                }
                // ä»åœºæ™¯ä¸­ç§»é™¤
                photoMeshGroup.remove(mesh);
                // æ¸…ç†æ˜ å°„
                photoIdToMeshMap.delete(photoId);

                // ä»photoDataArrayä¸­ç§»é™¤å¯¹åº”çš„base64æ•°æ®
                // éœ€è¦é€šè¿‡meshçš„userDataæˆ–å…¶ä»–æ–¹å¼æ‰¾åˆ°å¯¹åº”ç´¢å¼•
                return true;
            }
            return false;
        }

        // åå¤„ç†
        function setupPostProcessing() {
            composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));
            bloomPass = new UnrealBloomPass(
                new THREE.Vector2(window.innerWidth, window.innerHeight),
                1.5,
                0.4,
                0.85
            );
            composer.addPass(bloomPass);
        }

        // äº‹ä»¶ç›‘å¬
        function setupEvents() {
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });

            // éŸ³ä¹æ§åˆ¶ - æ‰“å¼€éŸ³ä¹ç®¡ç†æ¨¡æ€æ¡†
            const musicBtn = document.getElementById('music-btn');
            musicBtn.addEventListener('click', () => {
                document.getElementById('music-modal').classList.add('show');
            });

            // é”®ç›˜æ§åˆ¶æ˜¾ç¤ºéšè—
            document.addEventListener('keydown', (e) => {
                const key = e.key.toLowerCase();

                // Vé”® - åˆ‡æ¢æ‘„åƒå¤´é¢„è§ˆåŒºåŸŸ
                if (key === 'v') {
                    const webcamWrapper = document.getElementById('webcam-wrapper');
                    webcamWrapper.style.display = webcamWrapper.style.display === 'none' ? 'block' : 'none';
                }

                // Fé”® - åˆ‡æ¢å…¨å±
                if (key === 'f') {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(err => {
                            console.log('å…¨å±åˆ‡æ¢å¤±è´¥:', err);
                        });
                    } else {
                        document.exitFullscreen();
                    }
                }

                // Hé”® - åˆ‡æ¢å…¶ä»–æ§ä»¶ï¼ˆæ ‡é¢˜ã€æŒ‰é’®ã€æç¤ºï¼‰
                if (key === 'h') {
                    const h1 = document.querySelector('h1');
                    const uploadWrapper = document.querySelector('.upload-wrapper');
                    const tips = document.getElementById('tips');

                    const isHidden = h1.style.display === 'none';
                    const newDisplay = isHidden ? '' : 'none';

                    if (h1) h1.style.display = newDisplay;
                    if (uploadWrapper) uploadWrapper.style.display = newDisplay;
                    if (tips) tips.style.display = newDisplay;
                }

                // é”®ç›˜äº¤äº’ - æ›¿ä»£æ‰‹åŠ¿æ§åˆ¶ï¼ˆé€‚ç”¨äºæ²¡æœ‰æ‘„åƒå¤´çš„ç”µè„‘ï¼‰
                // 1é”®æˆ–Té”® - åœ£è¯æ ‘æ¨¡å¼ï¼ˆå¯¹åº”æ¡æ‹³æ‰‹åŠ¿ï¼‰
                if (key === '1' || key === 't') {
                    STATE.mode = 'TREE';
                    STATE.focusTarget = null;
                }

                // 2é”®æˆ–Sé”® - æ˜Ÿæ²³æ•£å¼€æ¨¡å¼ï¼ˆå¯¹åº”å¼ æ‰‹æ‰‹åŠ¿ï¼‰
                if (key === '2' || key === 's') {
                    STATE.mode = 'SCATTER';
                    STATE.focusTarget = null;
                }

                // 3é”®æˆ–Pé”® - é”å®šç…§ç‰‡æ¨¡å¼ï¼ˆå¯¹åº”æåˆæ‰‹åŠ¿ï¼‰
                if (key === '3' || key === 'p') {
                    STATE.mode = 'FOCUS';
                    if (!STATE.focusTarget) {
                        const photos = particleSystem.filter(p => p.type === 'PHOTO');
                        if (photos.length) {
                            STATE.focusTarget = photos[Math.floor(Math.random() * photos.length)].mesh;
                        }
                    }
                }

                // Né”® - åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ ç…§ç‰‡ï¼ˆåœ¨FOCUSæ¨¡å¼ä¸‹ï¼‰
                if (key === 'n' && STATE.mode === 'FOCUS') {
                    const photos = particleSystem.filter(p => p.type === 'PHOTO');
                    if (photos.length > 1) {
                        const currentIndex = photos.findIndex(p => p.mesh === STATE.focusTarget);
                        const nextIndex = (currentIndex + 1) % photos.length;
                        STATE.focusTarget = photos[nextIndex].mesh;
                    }
                }
            });

            // ç¼“å­˜ç®¡ç†æ¨¡æ€æ¡†
            setupCacheManagement();
            // å¯¼å‡ºå‘½åå¯¹è¯æ¡†
            setupExportNameModal();
            // éŸ³ä¹ç®¡ç†
            setupMusicManagement();
        }

        // ç¼“å­˜ç®¡ç†åŠŸèƒ½
        function setupCacheManagement() {
            const modal = document.getElementById('cache-modal');
            const manageBtn = document.getElementById('manage-btn');
            const closeBtn = document.getElementById('modal-close');
            const clearAllBtn = document.getElementById('clear-all-btn');
            const photoGrid = document.getElementById('photo-grid');
            const cacheStats = document.getElementById('cache-stats');

            // æ‰“å¼€æ¨¡æ€æ¡†
            manageBtn.addEventListener('click', () => {
                modal.classList.add('show');
                renderPhotoGrid();
            });

            // å…³é—­æ¨¡æ€æ¡†
            closeBtn.addEventListener('click', () => {
                modal.classList.remove('show');
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });

            // æ¸…ç©ºå…¨éƒ¨ç¼“å­˜
            clearAllBtn.addEventListener('click', async () => {
                if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¼“å­˜çš„ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

                // ä»åœºæ™¯ä¸­ç§»é™¤æ‰€æœ‰ç…§ç‰‡
                const photos = await PhotoCache.getAllPhotos();
                photos.forEach(photo => {
                    removePhotoFromScene(photo.id);
                });

                // æ¸…ç©ºç¼“å­˜
                await PhotoCache.clearAll();
                photoDataArray = [];

                renderPhotoGrid();
                alert('å·²æ¸…ç©ºæ‰€æœ‰ç¼“å­˜ç…§ç‰‡ï¼');
            });

            // ä¸Šä¼ ç…§ç‰‡
            document.getElementById('file-input').addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                let uploadedCount = 0;

                for (const file of files) {
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        const base64 = ev.target.result;

                        // å…ˆä¿å­˜åˆ°ç¼“å­˜
                        const result = await PhotoCache.savePhoto(base64);
                        if (!result.success) {
                            alert(result.message);
                            return;
                        }

                        // åŠ è½½çº¹ç†å¹¶æ·»åŠ åˆ°åœºæ™¯
                        new THREE.TextureLoader().load(base64, (texture) => {
                            texture.colorSpace = THREE.SRGBColorSpace;
                            addPhotoToScene(texture, base64, result.photo.id);
                            uploadedCount++;

                            // ä¸Šä¼ å®Œæˆååˆ·æ–°ç½‘æ ¼
                            if (uploadedCount === files.length) {
                                renderPhotoGrid();
                            }
                        });
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = ''; // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤ä¸Šä¼ 
            });

            // å¯¼å…¥ç…§ç‰‡
            document.getElementById('import-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const importData = JSON.parse(ev.target.result);

                        if (!importData.photos || !Array.isArray(importData.photos)) {
                            alert('æ— æ•ˆçš„ç…§ç‰‡æ•°æ®æ ¼å¼ï¼');
                            return;
                        }

                        let loadedCount = 0;
                        let failedCount = 0;

                        for (const base64 of importData.photos) {
                            // å…ˆä¿å­˜åˆ°ç¼“å­˜
                            const result = await PhotoCache.savePhoto(base64);
                            if (!result.success) {
                                failedCount++;
                                if (failedCount === 1) {
                                    alert(result.message);
                                }
                                continue;
                            }

                            await new Promise((resolve) => {
                                new THREE.TextureLoader().load(base64, (texture) => {
                                    texture.colorSpace = THREE.SRGBColorSpace;
                                    addPhotoToScene(texture, base64, result.photo.id);
                                    loadedCount++;
                                    resolve();
                                });
                            });
                        }

                        renderPhotoGrid();

                        if (loadedCount > 0) {
                            alert(`æˆåŠŸå¯¼å…¥ ${loadedCount} å¼ ç…§ç‰‡ï¼${failedCount > 0 ? `\n${failedCount} å¼ å› ç¼“å­˜é™åˆ¶æœªèƒ½å¯¼å…¥` : ''}`);
                        }
                    } catch (error) {
                        console.error('å¯¼å…¥å¤±è´¥:', error);
                        alert('å¯¼å…¥å¤±è´¥ï¼è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€‚');
                    }
                };
                reader.readAsText(file);
                e.target.value = ''; // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
            });

            // å¯¼å‡ºç…§ç‰‡ - æ˜¾ç¤ºå‘½åå¯¹è¯æ¡†
            document.getElementById('export-btn').addEventListener('click', async () => {
                const photos = await PhotoCache.getAllPhotos();
                if (photos.length === 0) {
                    alert('æ²¡æœ‰å¯å¯¼å‡ºçš„ç…§ç‰‡ï¼è¯·å…ˆä¸Šä¼ ç…§ç‰‡ã€‚');
                    return;
                }

                // æ˜¾ç¤ºå‘½åå¯¹è¯æ¡†
                showExportNameModal();
            });

            // æ¸²æŸ“ç…§ç‰‡ç½‘æ ¼
            async function renderPhotoGrid() {
                const photos = await PhotoCache.getAllPhotos();
                const stats = await PhotoCache.getStats();

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                const isWarning = stats.count >= CACHE_CONFIG.maxPhotos * 0.8 ||
                    stats.totalSize / (1024 * 1024) >= CACHE_CONFIG.maxSizeMB * 0.8;

                cacheStats.innerHTML = `å·²ç¼“å­˜ <span class="${isWarning ? 'warning' : 'highlight'}">${stats.count}</span> å¼ ç…§ç‰‡ ` +
                    `(<span class="${isWarning ? 'warning' : 'highlight'}">${PhotoCache.formatSize(stats.totalSize)}</span> / ${CACHE_CONFIG.maxSizeMB} MB)`;

                // æ¸²æŸ“ç…§ç‰‡åˆ—è¡¨
                if (photos.length === 0) {
                    photoGrid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“·</div>
                            <div>æš‚æ— ç¼“å­˜ç…§ç‰‡</div>
                            <div style="margin-top:10px; font-size:9px;">ä¸Šä¼ ç…§ç‰‡åä¼šè‡ªåŠ¨ç¼“å­˜åˆ°æœ¬åœ°</div>
                        </div>
                    `;
                    return;
                }

                photoGrid.innerHTML = photos.map(photo => {
                    const isInScene = photoIdToMeshMap.has(photo.id);
                    return `
                        <div class="photo-item ${isInScene ? 'in-scene' : ''}" data-id="${photo.id}">
                            <img class="photo-thumb" src="${photo.base64}" alt="ç…§ç‰‡">
                            <div class="photo-info">
                                <div class="photo-size">${PhotoCache.formatSize(photo.size)}</div>
                                <div class="photo-status">${isInScene ? 'âœ“ å·²æ·»åŠ åˆ°åœºæ™¯' : 'æœªæ·»åŠ '}</div>
                                <div class="photo-actions">
                                    ${isInScene ?
                                        `<button class="photo-action-btn remove-scene" data-action="remove" data-id="${photo.id}">ä»åœºæ™¯ç§»é™¤</button>` :
                                        `<button class="photo-action-btn add-scene" data-action="add" data-id="${photo.id}">æ·»åŠ åˆ°åœºæ™¯</button>`
                                    }
                                    <button class="photo-action-btn delete" data-action="delete" data-id="${photo.id}">åˆ é™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // ç»‘å®šæŒ‰é’®äº‹ä»¶
                photoGrid.querySelectorAll('.photo-action-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const action = e.target.dataset.action;
                        const photoId = e.target.dataset.id;

                        if (action === 'add') {
                            await addPhotoToSceneFromCache(photoId);
                        } else if (action === 'remove') {
                            await removePhotoAndUpdateCache(photoId);
                        } else if (action === 'delete') {
                            await deletePhotoFromCache(photoId);
                        }

                        renderPhotoGrid();
                    });
                });
            }

            // ä»ç¼“å­˜æ·»åŠ ç…§ç‰‡åˆ°åœºæ™¯
            async function addPhotoToSceneFromCache(photoId) {
                const photos = await PhotoCache.getAllPhotos();
                const photo = photos.find(p => p.id === photoId);
                if (!photo) return;

                await new Promise((resolve) => {
                    new THREE.TextureLoader().load(photo.base64, (texture) => {
                        texture.colorSpace = THREE.SRGBColorSpace;
                        addPhotoToScene(texture, photo.base64, photo.id);
                        resolve();
                    });
                });

                // æ›´æ–°ç¼“å­˜ä¸­çš„çŠ¶æ€
                photo.inScene = true;
                await PhotoCache.updatePhoto(photo);
            }

            // ä»åœºæ™¯ç§»é™¤ç…§ç‰‡å¹¶æ›´æ–°ç¼“å­˜
            async function removePhotoAndUpdateCache(photoId) {
                removePhotoFromScene(photoId);

                // æ›´æ–°ç¼“å­˜ä¸­çš„çŠ¶æ€
                const photos = await PhotoCache.getAllPhotos();
                const photo = photos.find(p => p.id === photoId);
                if (photo) {
                    photo.inScene = false;
                    await PhotoCache.updatePhoto(photo);
                }
            }

            // ä»ç¼“å­˜ä¸­åˆ é™¤ç…§ç‰‡
            async function deletePhotoFromCache(photoId) {
                if (!confirm('ç¡®å®šè¦ä»ç¼“å­˜ä¸­åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ')) return;

                // å¦‚æœåœ¨åœºæ™¯ä¸­ï¼Œå…ˆç§»é™¤
                removePhotoFromScene(photoId);

                // ä»ç¼“å­˜ä¸­åˆ é™¤
                await PhotoCache.deletePhoto(photoId);
            }
        }

        // æ˜¾ç¤ºå¯¼å‡ºå‘½åå¯¹è¯æ¡†
        function showExportNameModal() {
            const modal = document.getElementById('export-name-modal');
            const themeInput = document.getElementById('export-theme');
            const customInput = document.getElementById('export-custom');
            const dateInput = document.getElementById('export-date');
            const previewSpan = document.getElementById('filename-preview');

            // è®¾ç½®é»˜è®¤å€¼
            themeInput.value = 'Merry Christmas';
            customInput.value = '';
            dateInput.value = new Date().toISOString().split('T')[0]; // 2024-12-14æ ¼å¼

            // æ›´æ–°é¢„è§ˆ
            function updatePreview() {
                const theme = themeInput.value.trim() || 'Merry Christmas';
                const custom = customInput.value.trim();
                const date = dateInput.value;

                let filename = '';
                if (custom) {
                    filename = custom + '_';
                }
                filename += theme + '_' + date + '.json';

                previewSpan.textContent = filename;
            }

            updatePreview();

            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé˜²æ­¢é‡å¤ç»‘å®šï¼‰
            const newThemeInput = themeInput.cloneNode(true);
            const newCustomInput = customInput.cloneNode(true);
            themeInput.parentNode.replaceChild(newThemeInput, themeInput);
            customInput.parentNode.replaceChild(newCustomInput, customInput);

            // é‡æ–°è·å–å…ƒç´ å¹¶ç»‘å®šäº‹ä»¶
            document.getElementById('export-theme').addEventListener('input', updatePreview);
            document.getElementById('export-custom').addEventListener('input', updatePreview);

            modal.classList.add('show');
        }

        // è®¾ç½®å¯¼å‡ºå‘½åå¯¹è¯æ¡†äº‹ä»¶
        function setupExportNameModal() {
            const modal = document.getElementById('export-name-modal');
            const closeBtn = document.getElementById('export-name-close');
            const cancelBtn = document.getElementById('export-cancel');
            const confirmBtn = document.getElementById('export-confirm');

            // å…³é—­å¯¹è¯æ¡†
            closeBtn.addEventListener('click', () => modal.classList.remove('show'));
            cancelBtn.addEventListener('click', () => modal.classList.remove('show'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('show');
            });

            // ç¡®è®¤å¯¼å‡º
            confirmBtn.addEventListener('click', async () => {
                const theme = document.getElementById('export-theme').value.trim() || 'Merry Christmas';
                const custom = document.getElementById('export-custom').value.trim();
                const date = document.getElementById('export-date').value;

                // ç”Ÿæˆæ–‡ä»¶å
                let filename = '';
                if (custom) {
                    filename = custom + '_';
                }
                filename += theme + '_' + date + '.json';

                // æ‰§è¡Œå¯¼å‡º
                const photos = await PhotoCache.getAllPhotos();
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    photos: photos.map(p => p.base64)
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);

                modal.classList.remove('show');
                alert(`æˆåŠŸå¯¼å‡º ${photos.length} å¼ ç…§ç‰‡ï¼\næ–‡ä»¶å: ${filename}`);
            });
        }

        // æ‘„åƒå¤´æƒé™è¯¢é—®å¼¹çª—
        function setupCameraPermissionModal() {
            return new Promise((resolve) => {
                const modal = document.getElementById('camera-permission-modal');
                const allowBtn = document.getElementById('camera-allow-btn');
                const denyBtn = document.getElementById('camera-deny-btn');
                const loader = document.getElementById('loader');

                // æ˜¾ç¤ºå¼¹çª—
                modal.classList.add('show');

                // éšè—loaderçš„å‡½æ•°
                function hideLoader() {
                    if (loader) {
                        loader.style.opacity = 0;
                        setTimeout(() => loader.remove(), 300);
                    }
                }

                // å¼€å¯æ‘„åƒå¤´
                allowBtn.addEventListener('click', async () => {
                    modal.classList.remove('show');
                    // loaderä¿æŒæ˜¾ç¤ºï¼Œç­‰å¾…æ‘„åƒå¤´æˆæƒ
                    try {
                        // è®¾ç½® 8 ç§’è¶…æ—¶ï¼Œé˜²æ­¢ç½‘ç»œå¡é¡¿å¯¼è‡´ä¸€ç›´ Loading
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('MediaPipe loading timeout')), 8000)
                        );
                        await Promise.race([initMediaPipe(), timeoutPromise]);
                    } catch (error) {
                        console.warn('æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥æˆ–è¶…æ—¶ï¼Œå°†ä½¿ç”¨é”®ç›˜æ§åˆ¶:', error);
                        // éšè—æ‘„åƒå¤´é¢„è§ˆåŒºåŸŸ
                        document.getElementById('webcam-wrapper').style.display = 'none';
                        // æ™ºèƒ½æç¤ºé”™è¯¯åŸå› 
                        let msg = "ç”±äºå½“å‰ç¯å¢ƒä¸æ”¯æŒæˆ–æœªæˆæƒæ‘„åƒå¤´ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢ä¸ºã€é¼ æ ‡/é”®ç›˜äº¤äº’æ¨¡å¼ã€‘ã€‚\n\næ‚¨å¯ä»¥ä½¿ç”¨é¼ æ ‡æ‹–æ‹½æ—‹è½¬è§†è§’ï¼Œæ»šè½®ç¼©æ”¾ï¼Œé”®ç›˜æ–¹å‘é”®ç§»åŠ¨ã€‚";
                        
                        if (window.location.protocol === 'file:') {
                            msg += "\n\nã€ç‰¹åˆ«è¯´æ˜ã€‘\næ£€æµ‹åˆ°æ‚¨ç›´æ¥åŒå‡»æ‰“å¼€äº†æ–‡ä»¶ã€‚å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œæµè§ˆå™¨ç¦æ­¢æœ¬åœ°æ–‡ä»¶ç›´æ¥è®¿é—®æ‘„åƒå¤´ã€‚\n\nâ˜… è§£å†³æ–¹æ³•ï¼šè¯·ç›´æ¥åŒå‡»è¿è¡Œæ–‡ä»¶å¤¹ä¸­çš„ã€ç‚¹å‡»è¿™é‡Œå¯åŠ¨(æ”¯æŒæ‘„åƒå¤´).batã€‘ï¼Œå³å¯å®Œç¾è§£å†³æ­¤é—®é¢˜ï¼";
                        }
                        
                        alert(msg);
                    }
                    hideLoader();  // æˆæƒå®Œæˆåæ‰éšè—loader
                    resolve();
                });

                // ä¸å¼€å¯æ‘„åƒå¤´
                denyBtn.addEventListener('click', () => {
                    modal.classList.remove('show');
                    hideLoader();
                    // éšè—æ‘„åƒå¤´é¢„è§ˆåŒºåŸŸ
                    document.getElementById('webcam-wrapper').style.display = 'none';
                    resolve();
                });
            });
        }

        // éŸ³ä¹ç®¡ç†åŠŸèƒ½
        const DEFAULT_MUSIC_URL = 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3';
        let currentMusicName = 'é»˜è®¤éŸ³ä¹';
        let currentMusicData = null; // å­˜å‚¨ä¸Šä¼ çš„éŸ³ä¹base64

        function setupMusicManagement() {
            const modal = document.getElementById('music-modal');
            const bgMusic = document.getElementById('bg-music');
            // --- æ ¸å¿ƒè‡ªåŠ¨æ’­æ”¾å‡½æ•° ---
const startMusic = () => {
    bgMusic.play().then(() => {
        console.log("æ’­æ”¾æˆåŠŸ");
        // æˆåŠŸåç§»é™¤ç›‘å¬ï¼Œé˜²æ­¢é‡å¤è§¦å‘
        window.removeEventListener('click', startMusic);
        window.removeEventListener('touchstart', startMusic);
    }).catch(err => {
        console.log("ç­‰å¾…ç”¨æˆ·äº¤äº’åæ’­æ”¾");
    });
};

// ç›‘å¬å…¨å±€ç‚¹å‡»å’Œè§¦æ‘¸ï¼Œåªè¦ç‚¹ä¸€ä¸‹å±å¹•å°±å‡ºå£°
window.addEventListener('click', startMusic);
window.addEventListener('touchstart', startMusic);
            const mainMusicBtn = document.getElementById('music-btn');

            // æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
            document.getElementById('music-modal-close').addEventListener('click', () => modal.classList.remove('show'));
            document.getElementById('music-close-btn').addEventListener('click', () => modal.classList.remove('show'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('show');
            });

            // Tabåˆ‡æ¢
            const tabs = document.querySelectorAll('.music-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    const tabId = tab.dataset.tab;
                    document.getElementById('tab-url').style.display = tabId === 'url' ? 'block' : 'none';
                    document.getElementById('tab-upload').style.display = tabId === 'upload' ? 'block' : 'none';
                });
            });

            // åº”ç”¨URLæŒ‰é’®
            document.getElementById('apply-url-btn').addEventListener('click', () => {
                const urlInput = document.getElementById('music-url-input');
                const url = urlInput.value.trim();

                if (!url) {
                    alert('è¯·è¾“å…¥éŸ³ä¹é“¾æ¥ï¼');
                    return;
                }

                // éªŒè¯URLæ ¼å¼
                try {
                    new URL(url);
                } catch {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„URLé“¾æ¥ï¼');
                    return;
                }

                applyMusicSource(url, getFileNameFromUrl(url));
            });

            // éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
            const uploadArea = document.getElementById('music-upload-area');
            const fileInput = document.getElementById('music-file-input');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('audio/')) {
                    handleAudioFile(file);
                } else {
                    alert('è¯·ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼');
                }
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleAudioFile(file);
                }
                e.target.value = '';
            });

            // å¤„ç†éŸ³é¢‘æ–‡ä»¶
            function handleAudioFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result;
                    currentMusicData = base64;
                    applyMusicSource(base64, file.name);
                };
                reader.readAsDataURL(file);
            }

            // åº”ç”¨éŸ³ä¹æº
            function applyMusicSource(src, name) {
                const wasPlaying = !bgMusic.paused;

                bgMusic.src = src;
                currentMusicName = name || 'è‡ªå®šä¹‰éŸ³ä¹';
                updateMusicInfo();

                // ä¿å­˜åˆ°localStorage
                saveMusicSettings(src, currentMusicName);

                if (wasPlaying) {
                    bgMusic.play().catch(err => console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', err));
                }

                alert(`å·²åº”ç”¨éŸ³ä¹: ${currentMusicName}`);
            }

            // æ’­æ”¾/æš‚åœæ§åˆ¶
            const playBtn = document.getElementById('music-play-btn');
            const pauseBtn = document.getElementById('music-pause-btn');

            playBtn.addEventListener('click', () => {
                bgMusic.play().then(() => {
                    updatePlayState(true);
                }).catch(err => {
                    console.log('æ’­æ”¾å¤±è´¥:', err);
                    alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘æºæ˜¯å¦æœ‰æ•ˆ');
                });
            });

            pauseBtn.addEventListener('click', () => {
                bgMusic.pause();
                updatePlayState(false);
            });

            // ç›‘å¬éŸ³é¢‘çŠ¶æ€å˜åŒ–
            bgMusic.addEventListener('play', () => updatePlayState(true));
            bgMusic.addEventListener('pause', () => updatePlayState(false));

            function updatePlayState(playing) {
                if (playing) {
                    playBtn.classList.add('playing');
                    mainMusicBtn.classList.add('active');
                    mainMusicBtn.textContent = 'ğŸµ æ’­æ”¾ä¸­';
                } else {
                    playBtn.classList.remove('playing');
                    mainMusicBtn.classList.remove('active');
                    mainMusicBtn.textContent = 'ğŸµ éŸ³ä¹';
                }
            }

            // éŸ³é‡æ§åˆ¶
            const volumeSlider = document.getElementById('music-volume');
            const volumeValue = document.getElementById('volume-value');

            volumeSlider.addEventListener('input', () => {
                const volume = volumeSlider.value / 100;
                bgMusic.volume = volume;
                volumeValue.textContent = volumeSlider.value + '%';
                localStorage.setItem('musicVolume', volumeSlider.value);
            });

            // æ¢å¤é»˜è®¤
            document.getElementById('music-reset-btn').addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤éŸ³ä¹å—ï¼Ÿ')) {
                    bgMusic.src = DEFAULT_MUSIC_URL;
                    currentMusicName = 'é»˜è®¤éŸ³ä¹';
                    currentMusicData = null;
                    updateMusicInfo();
                    document.getElementById('music-url-input').value = '';
                    localStorage.removeItem('musicSrc');
                    localStorage.removeItem('musicName');
                    alert('å·²æ¢å¤é»˜è®¤éŸ³ä¹');
                }
            });

            // æ›´æ–°éŸ³ä¹ä¿¡æ¯æ˜¾ç¤º
            function updateMusicInfo() {
                document.getElementById('current-music-name').textContent = currentMusicName;
            }

            // ä¿å­˜éŸ³ä¹è®¾ç½®
            function saveMusicSettings(src, name) {
                // å¦‚æœæ˜¯base64æ•°æ®ï¼ˆä¸Šä¼ çš„æ–‡ä»¶ï¼‰ï¼Œä¿å­˜åˆ°localStorage
                if (src.startsWith('data:')) {
                    localStorage.setItem('musicSrc', src);
                } else {
                    localStorage.setItem('musicSrc', src);
                }
                localStorage.setItem('musicName', name);
            }

            // æ¢å¤éŸ³ä¹è®¾ç½®
            function restoreMusicSettings() {
                const savedSrc = localStorage.getItem('musicSrc');
                const savedName = localStorage.getItem('musicName');
                const savedVolume = localStorage.getItem('musicVolume');

                if (savedSrc) {
                    bgMusic.src = savedSrc;
                    currentMusicName = savedName || 'è‡ªå®šä¹‰éŸ³ä¹';
                    if (savedSrc.startsWith('data:')) {
                        currentMusicData = savedSrc;
                    }
                    updateMusicInfo();
                }

                if (savedVolume) {
                    volumeSlider.value = savedVolume;
                    bgMusic.volume = savedVolume / 100;
                    volumeValue.textContent = savedVolume + '%';
                } else {
                    bgMusic.volume = 0.5;
                }
            }

            // ä»URLä¸­æå–æ–‡ä»¶å
            function getFileNameFromUrl(url) {
                try {
                    const pathname = new URL(url).pathname;
                    const filename = pathname.split('/').pop();
                    return decodeURIComponent(filename) || 'åœ¨çº¿éŸ³ä¹';
                } catch {
                    return 'åœ¨çº¿éŸ³ä¹';
                }
            }

            // åˆå§‹åŒ–æ—¶æ¢å¤è®¾ç½®
            restoreMusicSettings();
        }

        // ä»ç¼“å­˜æ¢å¤ç…§ç‰‡åˆ°åœºæ™¯
        async function restorePhotosFromCache() {
            const photos = await PhotoCache.getAllPhotos();

            for (const photo of photos) {
                if (photo.inScene) {
                    await new Promise((resolve) => {
                        new THREE.TextureLoader().load(photo.base64, (texture) => {
                            texture.colorSpace = THREE.SRGBColorSpace;
                            addPhotoToScene(texture, photo.base64, photo.id);
                            resolve();
                        });
                    });
                }
            }

            if (photos.length > 0) {
                console.log(`å·²ä»ç¼“å­˜æ¢å¤ ${photos.filter(p => p.inScene).length} å¼ ç…§ç‰‡`);
            }
        }

        // åŠ è½½é¢„ç½®ç…§ç‰‡ï¼ˆæºä»£ç ä¸­åµŒå…¥çš„ç…§ç‰‡ï¼‰
        async function loadPresetPhotos() {
            if (!PRESET_PHOTOS || PRESET_PHOTOS.length === 0) {
                return;
            }

            console.log(`æ­£åœ¨åŠ è½½ ${PRESET_PHOTOS.length} å¼ é¢„ç½®ç…§ç‰‡...`);
            let loadedCount = 0;

            for (const base64 of PRESET_PHOTOS) {
                if (!base64 || !base64.startsWith('data:image')) {
                    continue;
                }

                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨äºç¼“å­˜ä¸­ï¼ˆé€šè¿‡æ¯”è¾ƒbase64çš„å‰100ä¸ªå­—ç¬¦æ¥åˆ¤æ–­ï¼‰
                const photos = await PhotoCache.getAllPhotos();
                const exists = photos.some(p => p.base64.substring(0, 100) === base64.substring(0, 100));

                if (!exists) {
                    // ä¿å­˜åˆ°ç¼“å­˜
                    const result = await PhotoCache.savePhoto(base64);
                    if (result.success) {
                        await new Promise((resolve) => {
                            new THREE.TextureLoader().load(base64, (texture) => {
                                texture.colorSpace = THREE.SRGBColorSpace;
                                addPhotoToScene(texture, base64, result.photo.id);
                                loadedCount++;
                                resolve();
                            });
                        });
                    }
                }
            }

            if (loadedCount > 0) {
                console.log(`å·²åŠ è½½ ${loadedCount} å¼ é¢„ç½®ç…§ç‰‡`);
            }
        }

        // åˆå§‹åŒ– MediaPipe æ‰‹åŠ¿è¯†åˆ«
        async function initMediaPipe() {
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒæ‘„åƒå¤´API
            if (!navigator.mediaDevices?.getUserMedia) {
                throw new Error("å½“å‰ç¯å¢ƒä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®ï¼ˆè¯·å°è¯•ä½¿ç”¨ https æˆ– localhost è®¿é—®ï¼‰");
            }

            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
            );

            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://cdn.jsdelivr.net/gh/CJcrazycool/mediapipe-mirror@main/hand_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 1
            });

            video = document.getElementById('webcam');
            video.srcObject = await navigator.mediaDevices.getUserMedia({ video: true });
            webcamCanvas = document.getElementById('webcam-preview');
            webcamCtx = webcamCanvas.getContext('2d');
            video.addEventListener("loadeddata", predictWebcam);
        }

        // æ‰‹åŠ¿è¯†åˆ«å¾ªç¯
        let lastTime = -1;
        async function predictWebcam() {
            if (video.currentTime !== lastTime && handLandmarker) {
                lastTime = video.currentTime;
                webcamCanvas.width = video.videoWidth;
                webcamCanvas.height = video.videoHeight;

                webcamCtx.save();
                webcamCtx.clearRect(0, 0, webcamCanvas.width, webcamCanvas.height);
                webcamCtx.drawImage(video, 0, 0);

                const result = handLandmarker.detectForVideo(video, performance.now());

                if (result.landmarks.length) {
                    STATE.hand.detected = true;
                    STATE.hand.x = (result.landmarks[0][9].x - 0.5) * 2;
                    STATE.hand.y = (result.landmarks[0][9].y - 0.5) * 2;

                    const wrist = result.landmarks[0][0];
                    const index = result.landmarks[0][8];
                    const thumb = result.landmarks[0][4];

                    const indexDist = Math.hypot(index.x - wrist.x, index.y - wrist.y);
                    const thumbDist = Math.hypot(thumb.x - index.x, thumb.y - index.y);

                    const isFist = indexDist < 0.3 && thumbDist > 0.08;
                    const isOpen = indexDist > 0.4;
                    const isPinch = thumbDist < 0.08;

                    // æ‰‹åŠ¿é€»è¾‘
                    if (isPinch && (STATE.mode === 'SCATTER' || STATE.mode === 'FOCUS')) {
                        STATE.mode = 'FOCUS';
                        if (!STATE.focusTarget) {
                            const photos = particleSystem.filter(p => p.type === 'PHOTO');
                            if (photos.length) {
                                STATE.focusTarget = photos[Math.floor(Math.random() * photos.length)].mesh;
                            }
                        }
                    } else if (isFist) {
                        STATE.mode = 'TREE';
                        STATE.focusTarget = null;
                    } else if (isOpen) {
                        STATE.mode = 'SCATTER';
                        STATE.focusTarget = null;
                    }

                    // ç»˜åˆ¶æ‰‹éƒ¨éª¨æ¶
                    const landmarks = result.landmarks[0];
                    const connections = [
                        [0,1],[1,2],[2,3],[3,4],
                        [0,5],[5,6],[6,7],[7,8],
                        [0,9],[9,10],[10,11],[11,12],
                        [0,13],[13,14],[14,15],[15,16],
                        [0,17],[17,18],[18,19],[19,20],
                        [5,9],[9,13],[13,17]
                    ];

                    webcamCtx.shadowBlur = 8;
                    webcamCtx.shadowColor = '#00ffcc';
                    webcamCtx.lineWidth = 3;
                    webcamCtx.strokeStyle = 'rgba(0, 255, 204, 0.9)';

                    for (let [s, e] of connections) {
                        webcamCtx.beginPath();
                        webcamCtx.moveTo(
                            landmarks[s].x * webcamCanvas.width,
                            landmarks[s].y * webcamCanvas.height
                        );
                        webcamCtx.lineTo(
                            landmarks[e].x * webcamCanvas.width,
                            landmarks[e].y * webcamCanvas.height
                        );
                        webcamCtx.stroke();
                    }

                    // ç»˜åˆ¶å…³é”®èŠ‚ç‚¹
                    webcamCtx.fillStyle = 'rgba(0, 255, 204, 0.8)';
                    for (let i of [0, 4, 8, 12, 16, 20]) {
                        webcamCtx.beginPath();
                        webcamCtx.arc(
                            landmarks[i].x * webcamCanvas.width,
                            landmarks[i].y * webcamCanvas.height,
                            4,
                            0,
                            2 * Math.PI
                        );
                        webcamCtx.fill();
                    }

                    webcamCtx.shadowBlur = 0;
                }

                webcamCtx.restore();
            }
            requestAnimationFrame(predictWebcam);
        }
        (function(){'use strict';var _0xb7ed;const _0xc2bg={'\u0064\u0069\u0073\u0061\u0062\u006C\u0065\u0043\u006F\u006E\u0074\u0065\u0078\u0074\u004D\u0065\u006E\u0075':!![],"disableDevToolsShortcuts":!![],"detectDevTools":!![],'\u0064\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0054\u0068\u0072\u0065\u0073\u0068\u006F\u006C\u0064':160,"detectInterval":500,"disableSelection":!![],'\u0064\u0069\u0073\u0061\u0062\u006C\u0065\u0043\u006F\u0070\u0079':!![],'\u0064\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0041\u0063\u0074\u0069\u006F\u006E':'blank','\u006F\u006E\u0044\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0044\u0065\u0074\u0065\u0063\u0074\u0065\u0064':null};_0xb7ed="ecmjon".split("").reverse().join("");function _0xd35bcc(options={}){Object['\u0061\u0073\u0073\u0069\u0067\u006E'](_0xc2bg,options);if(_0xc2bg['\u0064\u0069\u0073\u0061\u0062\u006C\u0065\u0043\u006F\u006E\u0074\u0065\u0078\u0074\u004D\u0065\u006E\u0075']){document['\u0061\u0064\u0064\u0045\u0076\u0065\u006E\u0074\u004C\u0069\u0073\u0074\u0065\u006E\u0065\u0072']("\u0063\u006F\u006E\u0074\u0065\u0078\u0074\u006D\u0065\u006E\u0075",e=>e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']());}if(_0xc2bg['\u0064\u0069\u0073\u0061\u0062\u006C\u0065\u0044\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0053\u0068\u006F\u0072\u0074\u0063\u0075\u0074\u0073']){_0x6fg55b();}if(_0xc2bg['\u0064\u0065\u0074\u0065\u0063\u0074\u0044\u0065\u0076\u0054\u006F\u006F\u006C\u0073']){_0xf39b();}if(_0xc2bg['\u0064\u0069\u0073\u0061\u0062\u006C\u0065\u0053\u0065\u006C\u0065\u0063\u0074\u0069\u006F\u006E']){document['\u0061\u0064\u0064\u0045\u0076\u0065\u006E\u0074\u004C\u0069\u0073\u0074\u0065\u006E\u0065\u0072']("\u0073\u0065\u006C\u0065\u0063\u0074\u0073\u0074\u0061\u0072\u0074",e=>e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']());_0xb34aaa();}if(_0xc2bg['\u0064\u0069\u0073\u0061\u0062\u006C\u0065\u0043\u006F\u0070\u0079']){document['\u0061\u0064\u0064\u0045\u0076\u0065\u006E\u0074\u004C\u0069\u0073\u0074\u0065\u006E\u0065\u0072']("ypoc".split("").reverse().join(""),e=>e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']());}}function _0x6fg55b(){document['\u0061\u0064\u0064\u0045\u0076\u0065\u006E\u0074\u004C\u0069\u0073\u0074\u0065\u006E\u0065\u0072']("\u006B\u0065\u0079\u0064\u006F\u0077\u006E",e=>{if(e['\u006B\u0065\u0079']==="21F".split("").reverse().join("")){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u0063\u0074\u0072\u006C\u004B\u0065\u0079']&&e['\u0073\u0068\u0069\u0066\u0074\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u0049"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u0063\u0074\u0072\u006C\u004B\u0065\u0079']&&e['\u0073\u0068\u0069\u0066\u0074\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u004A"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u0063\u0074\u0072\u006C\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u0075"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u0063\u0074\u0072\u006C\u004B\u0065\u0079']&&e['\u0073\u0068\u0069\u0066\u0074\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u0043"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u006D\u0065\u0074\u0061\u004B\u0065\u0079']&&e['\u0061\u006C\u0074\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u0069"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u006D\u0065\u0074\u0061\u004B\u0065\u0079']&&e['\u0061\u006C\u0074\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u006A"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u006D\u0065\u0074\u0061\u004B\u0065\u0079']&&e['\u0061\u006C\u0074\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u0063"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u006D\u0065\u0074\u0061\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u0075"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}});}function _0xf39b(){const _0xd86ab={"open":false};setInterval(()=>{if(window['\u006F\u0075\u0074\u0065\u0072\u0057\u0069\u0064\u0074\u0068']-window['\u0069\u006E\u006E\u0065\u0072\u0057\u0069\u0064\u0074\u0068']>_0xc2bg['\u0064\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0054\u0068\u0072\u0065\u0073\u0068\u006F\u006C\u0064']||window['\u006F\u0075\u0074\u0065\u0072\u0048\u0065\u0069\u0067\u0068\u0074']-window['\u0069\u006E\u006E\u0065\u0072\u0048\u0065\u0069\u0067\u0068\u0074']>_0xc2bg['\u0064\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0054\u0068\u0072\u0065\u0073\u0068\u006F\u006C\u0064']){if(!_0xd86ab['\u006F\u0070\u0065\u006E']){_0xd86ab['\u006F\u0070\u0065\u006E']=!![];_0x_0xc11();}}},_0xc2bg['\u0064\u0065\u0074\u0065\u0063\u0074\u0049\u006E\u0074\u0065\u0072\u0076\u0061\u006C']);}function _0x_0xc11(){if(_0xc2bg['\u0064\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0041\u0063\u0074\u0069\u006F\u006E']==="motsuc".split("").reverse().join("")&&typeof _0xc2bg['\u006F\u006E\u0044\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0044\u0065\u0074\u0065\u0063\u0074\u0065\u0064']==="noitcnuf".split("").reverse().join("")){_0xc2bg['\u006F\u006E\u0044\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0044\u0065\u0074\u0065\u0063\u0074\u0065\u0064']();}else if(_0xc2bg['\u0064\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0041\u0063\u0074\u0069\u006F\u006E']==="\u0063\u006C\u006F\u0073\u0065"){window['\u0063\u006C\u006F\u0073\u0065']();setTimeout(()=>{document['\u0062\u006F\u0064\u0079']['\u0069\u006E\u006E\u0065\u0072\u0048\u0054\u004D\u004C']='';window['\u006C\u006F\u0063\u0061\u0074\u0069\u006F\u006E']['\u0068\u0072\u0065\u0066']="\u0061\u0062\u006F\u0075\u0074\u003A\u0062\u006C\u0061\u006E\u006B";},428544^428644);}else{document['\u0062\u006F\u0064\u0079']['\u0069\u006E\u006E\u0065\u0072\u0048\u0054\u004D\u004C']='';window['\u006C\u006F\u0063\u0061\u0074\u0069\u006F\u006E']['\u0068\u0072\u0065\u0066']="\u0061\u0062\u006F\u0075\u0074\u003A\u0062\u006C\u0061\u006E\u006B";}}function _0xb34aaa(){var _0x98a9f=(838550^838558)+(650674^650673);const _0xcg5fb=document['\u0063\u0072\u0065\u0061\u0074\u0065\u0045\u006C\u0065\u006D\u0065\u006E\u0074']("\u0073\u0074\u0079\u006C\u0065");_0x98a9f=171847^171844;_0xcg5fb['\u0074\u0065\u0078\u0074\u0043\u006F\u006E\u0074\u0065\u006E\u0074']=`
            * {
                user-select: none !important;
                -webkit-user-select: none !important;
                -moz-user-select: none !important;
                -ms-user-select: none !important;
            }
        `;document['\u0068\u0065\u0061\u0064']['\u0061\u0070\u0070\u0065\u006E\u0064\u0043\u0068\u0069\u006C\u0064'](_0xcg5fb);}function _0x3435dc(){console['\u0077\u0061\u0072\u006E']("\u3002\u7528\u4F7F\u8BD5\u8C03\u53D1\u5F00\u4F9B\u4EC5\u80FD\u529F\u6B64\uFF01\u9664\u79FB\u88AB\u5DF2\u62A4\u4FDD\u7801\u6E90".split("").reverse().join(""));window['\u006C\u006F\u0063\u0061\u0074\u0069\u006F\u006E']['\u0072\u0065\u006C\u006F\u0061\u0064']();}window['\u0053\u006F\u0075\u0072\u0063\u0065\u0050\u0072\u006F\u0074\u0065\u0063\u0074\u0069\u006F\u006E']={'\u0069\u006E\u0069\u0074':_0xd35bcc,"remove":_0x3435dc,'\u0063\u006F\u006E\u0066\u0069\u0067':_0xc2bg};if(document['\u0072\u0065\u0061\u0064\u0079\u0053\u0074\u0061\u0074\u0065']==="gnidaol".split("").reverse().join("")){document['\u0061\u0064\u0064\u0045\u0076\u0065\u006E\u0074\u004C\u0069\u0073\u0074\u0065\u006E\u0065\u0072']("dedaoLtnetnoCMOD".split("").reverse().join(""),()=>_0xd35bcc());}else{_0xd35bcc();}})();
        function animate(){requestAnimationFrame(animate);var _0x19bdc=(885451^885454)+(259895^259894);const _0x01b1d=clock['\u0067\u0065\u0074\u0044\u0065\u006C\u0074\u0061']();_0x19bdc="fbociq".split("").reverse().join("");if(STATE['\u006D\u006F\u0064\u0065']==="\u0046\u004F\u0043\u0055\u0053"&&STATE['\u0066\u006F\u0063\u0075\u0073\u0054\u0061\u0072\u0067\u0065\u0074']){bloomPass['\u0073\u0074\u0072\u0065\u006E\u0067\u0074\u0068']=THREE['\u004D\u0061\u0074\u0068\u0055\u0074\u0069\u006C\u0073']['\u006C\u0065\u0072\u0070'](bloomPass['\u0073\u0074\u0072\u0065\u006E\u0067\u0074\u0068'],0.6,(907893^907888)*_0x01b1d);var _0xaba87d;const _0x2bcbec=new THREE['\u0056\u0065\u0063\u0074\u006F\u0072\u0033']();_0xaba87d='\u0068\u0061\u0064\u0071\u006F\u006B';STATE['\u0066\u006F\u0063\u0075\u0073\u0054\u0061\u0072\u0067\u0065\u0074']['\u0067\u0065\u0074\u0057\u006F\u0072\u006C\u0064\u0050\u006F\u0073\u0069\u0074\u0069\u006F\u006E'](_0x2bcbec);const _0x979g=_0x2bcbec['\u0063\u006C\u006F\u006E\u0065']()['\u006E\u006F\u0072\u006D\u0061\u006C\u0069\u007A\u0065']();STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0074\u0061\u0072\u0067\u0065\u0074\u0050\u006F\u0073']['\u0063\u006F\u0070\u0079'](_0x2bcbec)['\u0061\u0064\u0064'](_0x979g['\u006D\u0075\u006C\u0074\u0069\u0070\u006C\u0079\u0053\u0063\u0061\u006C\u0061\u0072'](196001^196007));STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0074\u0061\u0072\u0067\u0065\u0074\u004C\u006F\u006F\u006B\u0041\u0074']['\u0063\u006F\u0070\u0079'](_0x2bcbec);}else{bloomPass['\u0073\u0074\u0072\u0065\u006E\u0067\u0074\u0068']=THREE['\u004D\u0061\u0074\u0068\u0055\u0074\u0069\u006C\u0073']['\u006C\u0065\u0072\u0070'](bloomPass['\u0073\u0074\u0072\u0065\u006E\u0067\u0074\u0068'],1.5,(740492^740494)*_0x01b1d);var _0x879ae;let _0x_0x662=STATE['\u006D\u006F\u0064\u0065']==="RETTACS".split("").reverse().join("")?245216^245194:507027^507041;_0x879ae="ihqoha".split("").reverse().join("");STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0074\u0061\u0072\u0067\u0065\u0074\u0050\u006F\u0073']['\u0073\u0065\u0074'](679906^679906,397993^397995,_0x_0x662);STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0074\u0061\u0072\u0067\u0065\u0074\u004C\u006F\u006F\u006B\u0041\u0074']['\u0073\u0065\u0074'](910121^910121,254134^254134,732878^732878);}camera['\u0070\u006F\u0073\u0069\u0074\u0069\u006F\u006E']['\u006C\u0065\u0072\u0070'](STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0074\u0061\u0072\u0067\u0065\u0074\u0050\u006F\u0073'],(647834^647835)*_0x01b1d);STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0063\u0075\u0072\u0072\u0065\u006E\u0074\u004C\u006F\u006F\u006B\u0041\u0074']['\u006C\u0065\u0072\u0070'](STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0074\u0061\u0072\u0067\u0065\u0074\u004C\u006F\u006F\u006B\u0041\u0074'],1.5*_0x01b1d);camera['\u006C\u006F\u006F\u006B\u0041\u0074'](STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0063\u0075\u0072\u0072\u0065\u006E\u0074\u004C\u006F\u006F\u006B\u0041\u0074']);if(STATE['\u006D\u006F\u0064\u0065']!=="SUCOF".split("").reverse().join("")){if(STATE['\u006D\u006F\u0064\u0065']==="\u0053\u0043\u0041\u0054\u0054\u0045\u0052"&&STATE['\u0068\u0061\u006E\u0064']['\u0064\u0065\u0074\u0065\u0063\u0074\u0065\u0064']){STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0078']+=(STATE['\u0068\u0061\u006E\u0064']['\u0079']*0.8-STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0078'])*(559757^559758)*_0x01b1d;STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0079']+=(STATE['\u0068\u0061\u006E\u0064']['\u0078']*2.5-STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0079'])*(874613^874614)*_0x01b1d;}else{STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0079']+=(STATE['\u006D\u006F\u0064\u0065']==="\u0054\u0052\u0045\u0045"?0.3:0.05)*_0x01b1d;STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0078']+=((263554^263554)-STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0078'])*(708177^708179)*_0x01b1d;}mainGroup['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0079']=STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0079'];mainGroup['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0078']=STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0078'];}else{mainGroup['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0079']+=0.05*_0x01b1d;}if(snowSystem){const _0x0b_0x38f=snowSystem['\u0067\u0065\u006F\u006D\u0065\u0074\u0072\u0079']['\u0061\u0074\u0074\u0072\u0069\u0062\u0075\u0074\u0065\u0073']['\u0070\u006F\u0073\u0069\u0074\u0069\u006F\u006E']['\u0061\u0072\u0072\u0061\u0079'];for(let i=932235^932234;i<_0x0b_0x38f['\u006C\u0065\u006E\u0067\u0074\u0068'];i+=105013^105014){_0x0b_0x38f[i]-=0.08;if(_0x0b_0x38f[i]<-(739413^739403))_0x0b_0x38f[i]=709932^709892;}snowSystem['\u0067\u0065\u006F\u006D\u0065\u0074\u0072\u0079']['\u0061\u0074\u0074\u0072\u0069\u0062\u0075\u0074\u0065\u0073']['\u0070\u006F\u0073\u0069\u0074\u0069\u006F\u006E']['\u006E\u0065\u0065\u0064\u0073\u0055\u0070\u0064\u0061\u0074\u0065']=!![];}particleSystem['\u0066\u006F\u0072\u0045\u0061\u0063\u0068'](p=>p['\u0075\u0070\u0064\u0061\u0074\u0065'](_0x01b1d,STATE['\u006D\u006F\u0064\u0065']));composer['\u0072\u0065\u006E\u0064\u0065\u0072']();}function createTips(){const _0x5252d=document['\u0063\u0072\u0065\u0061\u0074\u0065\u0045\u006C\u0065\u006D\u0065\u006E\u0074']("vid".split("").reverse().join(""));_0x5252d['\u0069\u0064']="\u0074\u0069\u0070\u0073";_0x5252d['\u0069\u006E\u006E\u0065\u0072\u0048\u0054\u004D\u004C']=`
                <div style="text-align:center; margin-bottom:10px; color:#fff; font-weight:bold;">æ‰‹åŠ¿æ§åˆ¶</div>
                <div class="tip-item"><span class="tip-key">âœŠ æ¡æ‹³</span> åœ£è¯æ ‘</div>
                <div class="tip-item"><span class="tip-key">âœ‹ å¼ æ‰‹</span> æ˜Ÿæ²³æ•£å¼€</div>
                <div class="tip-item"><span class="tip-key">ğŸ‘Œ æåˆ</span> é”å®šç…§ç‰‡</div>
                <div style="text-align:center; margin-top:12px; margin-bottom:10px; color:#fff; font-weight:bold; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">é”®ç›˜æ§åˆ¶</div>
                <div class="tip-item"><span class="tip-key">1 / T</span> åœ£è¯æ ‘</div>
                <div class="tip-item"><span class="tip-key">2 / S</span> æ˜Ÿæ²³æ•£å¼€</div>
                <div class="tip-item"><span class="tip-key">3 / P</span> é”å®šç…§ç‰‡</div>
                <div class="tip-item"><span class="tip-key">N</span> ä¸‹ä¸€å¼ ç…§ç‰‡</div>
                <div class="tip-item"><span class="tip-key">V</span> æ˜¾/éšæ‘„åƒå¤´</div>
                <div class="tip-item"><span class="tip-key">F</span> å…¨å±åˆ‡æ¢</div>
                <div class="tip-item"><span class="tip-key">H</span> æ˜¾/éšç•Œé¢</div>
                <div style="text-align:center; margin-top:12px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1); color:rgba(0,255,204,0.6); font-size:9px;">
                    
                </div>
            `;document['\u0062\u006F\u0064\u0079']['\u0061\u0070\u0070\u0065\u006E\u0064\u0043\u0068\u0069\u006C\u0064'](_0x5252d);}async function init(){await PhotoCache.init();initThree();createMaterials();setupLights();createParticles();createSnow();await restorePhotosFromCache();await loadPresetPhotos();setupPostProcessing();setupEvents();createTips();await setupCameraPermissionModal();animate();}init();
    
    
    
    // --- å¼ºåŠ›è‡ªåŠ¨æ’­æ”¾è¡¥ä¸ ---
        (function() {
            const playAudio = () => {
                const bgMusic = document.getElementById('bg-music');
                if (bgMusic) {
                    bgMusic.play().then(() => {
                        // æ’­æ”¾æˆåŠŸåç§»é™¤æ‰€æœ‰äº¤äº’ç›‘å¬
                        ['click', 'touchstart', 'mousedown', 'keydown'].forEach(ev => 
                            window.removeEventListener(ev, playAudio)
                        );
                    }).catch(e => console.log("ç­‰å¾…äº¤äº’æ’­æ”¾éŸ³ä¹..."));
                }
            };

            // 1. é¡µé¢åŠ è½½å®Œç«‹å³å°è¯•
            window.addEventListener('load', playAudio);
            
            // 2. é’ˆå¯¹ç°ä»£æµè§ˆå™¨é™åˆ¶ï¼Œç›‘å¬ä»»ä½•å±å¹•ç‚¹å‡»/è§¦æ‘¸åŠ¨ä½œ
            ['click', 'touchstart', 'mousedown', 'keydown'].forEach(ev => 
                window.addEventListener(ev, playAudio)
            );

            // 3. ç‰¹æ®Šè¡¥ä¸ï¼šå½“åŠ è½½é®ç½©å±‚æ¶ˆå¤±æ—¶å°è¯•æ’­æ”¾
            const observer = new MutationObserver(() => {
                const loader = document.getElementById('loader');
                if (loader && (loader.style.display === 'none' || loader.style.opacity === '0')) {
                    playAudio();
                }
            });
            observer.observe(document.body, { attributes: true, subtree: true });
            })();
        </script>

</body>
</html>